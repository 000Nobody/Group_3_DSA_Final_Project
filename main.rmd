---
title: "main"
output: html_document
date: "2023-07-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(dplyr, ggplot2, glmnet, tidyverse, janitor)
```

**Starting by importing and cleaning data**

```{r}
data <- read.csv("data/MA_Public_Schools_2017.csv")

# Remove MCAS, AP columns
data_hs <- data[, -c(98:293, 80:93, 16:25)]
names(data_hs)

# Select only high schools, create total_sat column, remove NAs and blank vals, clean column names
data_hs <- data_hs %>% 
  filter(
    Grade == "09,10,11,12"
  ) %>% 
  select(-c(
    Function, 
    State, 
    Address.2, 
    Phone, 
    Fax, 
    Contact.Name, 
    School.Code)
  ) %>%
  mutate(total_sat = (
    Average.SAT_Math + Average.SAT_Reading + Average.SAT_Writing) * (2/3)
  ) %>% 
  remove_empty(which = c("cols", "rows")) %>%
  drop_na() %>%
  clean_names()

dim(data_hs)

# Split data into training and testing 
picked = sample(seq_len(nrow(data_hs)), size = 150)
data.training = data_hs[picked,]
data.testing = data_hs[-picked,]
```

**Basic EDA**

```{r}
depend_vars <- data_hs %>% 
  summarise(name = school_name, sat = total_sat, grad_rate = x_graduated, college_rate = x_attending_college)

indep_vars <- data_hs %>% select(-c(
  school_name,
  grade,
  address_1,
  school_type,
  zip,
  town,
  average_sat_math,
  average_sat_reading,
  average_sat_writing,
  district_name
)) %>% 
  mutate_if(is.character, as.factor)

# Graphing the distribution of dependent variables
depend_vars %>% ggplot(aes(x = sat)) + 
  geom_histogram(bins = 20, fill = "blue", col = "black") + 
  labs(title = "Average SAT Histogram", x = "Average SAT Score", y = "Frequency")

depend_vars %>% ggplot(aes(x = grad_rate)) + 
  geom_histogram(bins = 50, fill = "blue", col = "black") + 
  labs(title = "Graduation Rate Histogram")

depend_vars %>% ggplot(aes(x = college_rate)) + 
  geom_histogram(bins = 30, fill = "blue", col = "black") + 
  labs(title = "College Attendance Rate Histogram")

indep_vars %>% ggplot(aes(x = salary_totals)) + 
  geom_histogram(bins = 30, fill = "blue", col = "black") + 
  labs(title = "Average Salary Histogram")

```

**Importing Crime Data**

```{r}
crime_data <- read.csv("data/MA_Crime.csv")
crime_data <- crime_data %>% clean_names()
# crime_data_per_capita <- crime_data[, c(3:12)] / data.frame(crime_data$population
# names(crime_data)
```

**LASSO Model for SAT**

```{r}
set.seed(1)

# str(indep_vars)

X.sat <- model.matrix(total_sat ~ ., data = indep_vars)
Y.sat <- indep_vars$total_sat

lasso_sat <- cv.glmnet(x = X.sat, y = Y.sat, alpha = .99, nfolds = 10)

plot(lasso_sat)
coef(lasso_sat, s = "lambda.1se")
```
