---
title: "main"
output: html_document
date: "2023-07-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(dplyr, ggplot2, glmnet, tidyverse, janitor, MASS)
```

**Starting by importing and cleaning data**

```{r}
data <- read.csv("data/MA_Public_Schools_2017.csv", stringsAsFactors = T)

# Remove MCAS, AP columns
data_hs <- data[, -c(299:300, 98:295, 80:93, 16:25)]
# names(data_hs)

# Select only schools with high schoolers enrolled, clean column names
data_hs <- data_hs %>% 
  filter(
    (data_hs$X9_Enrollment !=0 | data_hs$X10_Enrollment !=0 | data_hs$X11_Enrollment !=0 | data_hs$X12_Enrollment !=0)
  ) %>% 
  dplyr::select(-c(
    Function, 
    State, 
    Address.1,
    Address.2, 
    Phone, 
    Fax, 
    Contact.Name, 
    School.Code, 
    SP_Enrollment, 
    TOTAL_Enrollment, 
    First.Language.Not.English, 
    English.Language.Learner, 
    Students.With.Disabilities, 
    High.Needs, 
    Economically.Disadvantaged, 
    Number.of.Students, 
    High.School.Graduates...., 
    Attending.Coll..Univ.....,
    Total.Expenditures,
    X..High.Needs)
  ) %>% 
  mutate(total_hs_enrollment = (
    X9_Enrollment + X10_Enrollment + X11_Enrollment + X12_Enrollment), 
    total_sat = (
      Average.SAT_Math + Average.SAT_Reading + Average.SAT_Writing) * (2/3)
  ) %>%
  mutate_if(is.character, as.factor) %>% 
  clean_names()

```
**Importing Crime Data**

```{r}
crime_data <- read.csv("data/MA_Crime.csv")
crime_data <- crime_data %>% clean_names() %>% rename(town = city) %>% mutate_if(is.numeric, as.character)

crime_data[2:12] <- lapply(crime_data[2:12], readr::parse_number)

crime_data_per_capita <- (crime_data[, 3:12] / crime_data[, 2]) * 100000
crime_data_per_capita <- cbind(crime_data[1:2], crime_data_per_capita)

data_hs <- merge(data_hs, crime_data_per_capita, by="town")[, -77]
```

**Splitting and organizing data**
```{r}
# Split data into training and testing 
picked = sample(seq_len(nrow(data_hs)), size = 220)
data_hs.training = data_hs[picked,]
data_hs.testing = data_hs[-picked,]

#create new data frame with average total sat score, remove NAs
data_hs_sat <- data_hs.training %>% 
  dplyr::select(-c(
    average_sat_math, 
    average_sat_reading, 
    average_sat_writing,
    school_name,
    town,
    zip,
    grade,
    district_name,
    district_code,
    x_graduated,
    x_attending_college,
    x_private_two_year, 
    x_private_four_year, 
    x_public_two_year, 
    x_public_four_year, 
    x_ma_community_college, 
    x_ma_state_university, 
    x_u_mass
  )) %>% 
  remove_empty(which = c("cols", "rows")) %>%
  drop_na()

data_hs_gradrate <- data_hs.training %>% 
  filter(is.na(x_graduated) == F) %>% 
  dplyr::select(-c(
    school_name,
    town,
    zip,
    grade,
    district_name,
    district_code,
    x_attending_college,
    x_private_two_year, 
    x_private_four_year, 
    x_public_two_year, 
    x_public_four_year, 
    x_ma_community_college, 
    x_ma_state_university, 
    x_u_mass,
    x_dropped_out,
    x_still_in_school,
    x_non_grad_completers,
    x_ged
  )) %>% 
  remove_empty(which = c("cols", "rows")) %>%
  drop_na()

data_hs_college <- data_hs.training %>% 
  filter(is.na(x_attending_college) == F) %>% 
  dplyr::select(-c(
    school_name,
    town,
    zip,
    grade,
    district_name,
    district_code,
    x_private_two_year, 
    x_private_four_year, 
    x_public_two_year, 
    x_public_four_year, 
    x_ma_community_college, 
    x_ma_state_university, 
    x_u_mass)) %>% 
  drop_na()
  

# dim(data_hs_sat)
# dim(data_hs_gradrate)
# dim(data_hs_college)
```

**Basic EDA**

```{r}
depend_vars <- data_hs_sat %>% 
  summarise(name = school_name, sat = total_sat, grad_rate = x_graduated, college_rate = x_attending_college)

indep_vars <- data_hs %>% dplyr::select(-c(
  school_name,
  grade,
  address_1,
  school_type,
  zip,
  town,
  average_sat_math,
  average_sat_reading,
  average_sat_writing,
  district_name
)) %>% 
  mutate_if(is.character, as.factor)

# Graphing the distribution of dependent variables
data_hs_sat %>% ggplot(aes(x = total_sat)) + 
  geom_histogram(bins = 20, fill = "blue", col = "black") + 
  labs(title = "Average SAT Histogram", x = "Average SAT Score", y = "Frequency")

data_hs_gradrate %>% ggplot(aes(x = x_graduated)) + 
  geom_histogram(bins = 50, fill = "blue", col = "black") + 
  labs(title = "Graduation Rate Histogram")

data_hs_college %>% ggplot(aes(x = x_attending_college)) + 
  geom_histogram(bins = 30, fill = "blue", col = "black") + 
  labs(title = "College Attendance Rate Histogram")

indep_vars %>% ggplot(aes(x = salary_totals)) + 
  geom_histogram(bins = 30, fill = "blue", col = "black") + 
  labs(title = "Average Salary Histogram")
```


**LASSO Model for SAT**

```{r}
set.seed(1)

X.sat <- model.matrix(total_sat ~ ., data = data_hs_sat)
Y.sat <- data_hs_sat$total_sat

lasso_sat <- cv.glmnet(x = X.sat, y = Y.sat, alpha = .99, nfolds = 10)
plot(lasso_sat)

coef.sat <- coef(lasso_sat, s="lambda.1se")
coef.sat <- coef.sat[which(coef.sat !=0),]
var.sat <- rownames(as.matrix(coef.sat))[-1]

data_hs_sat.sub <- data_hs_sat[,c(var.sat, "total_sat")] 

fit.sat <- lm(total_sat ~ ., data = data_hs_sat.sub)
model.sat <- stepAIC(fit.sat, direction = "both", trace = FALSE)
summary(model.sat)
plot(model.sat)

sat_test_result <- data.frame(predicted = predict(model.min.sat, data_hs.testing), actual = data_hs.testing$total_sat)
plot(x = sat_test_result$predicted, y = sat_test_result$actual)

sjPlot::plot_model(model.sat, type = 'pred', terms = c('x_economically_disadvantaged'))

```

**LASSO Model for Graduation Rate**
```{r}
set.seed(1)

X.grad <- model.matrix(x_graduated ~ ., data = data_hs_gradrate)
Y.grad <- data_hs_gradrate$x_graduated

lasso_grad <- cv.glmnet(x = X.grad, y = Y.grad, alpha = .99, nfolds = 10)
plot(lasso_grad)

coef.grad <- coef(lasso_grad, s="lambda.1se")
coef.grad <- coef.grad[which(coef.grad !=0),]
var.grad <- rownames(as.matrix(coef.grad))[-1]

data_hs_gradrate.sub <- data_hs_gradrate[,c(var.grad, "x_graduated")]

fit.grad <- lm(x_graduated ~ ., data = data_hs_gradrate.sub)
model.grad <- stepAIC(fit.grad, direction = "both", trace = FALSE)
summary(model.grad)
plot(model.grad)

# sat_test_result <- data.frame(predicted = predict(model.min.sat, data_hs.testing), actual = data_hs.testing$total_sat)
# plot(x = sat_test_result$predicted, y = sat_test_result$actual)
```

**LASSO Model for College Attendance Rate**
```{r}
set.seed(1)

X.coll <- model.matrix(x_attending_college ~ ., data = data_hs_college)
Y.coll <- data_hs_college$x_attending_college

lasso_coll <- cv.glmnet(x = X.coll, y = Y.coll, alpha = .99, nfolds = 10)
plot(lasso_coll)

coef.coll <- coef(lasso_coll, s="lambda.min")
coef.coll <- coef.coll[which(coef.coll !=0),]
var.coll <- rownames(as.matrix(coef.coll))[-1]

data_hs_college.sub <- data_hs_college[,c(var.coll, "x_attending_college")]

fit.coll <- lm(x_attending_college ~ ., data = data_hs_college.sub)
model.coll <- stepAIC(fit.coll, direction = "both", trace = FALSE)
summary(model.coll)
plot(model.coll)
```

**Linear Models with theoretically important variables**
```{r}
data_hs.lm_training <- data_hs.training %>% 
  dplyr::select(c(
    average_class_size,
    x_economically_disadvantaged,
    x_english_language_learner,
    average_expenditures_per_pupil,
    x_females,
    average_salary,
    x_students_with_disabilities,
    average_in_district_expenditures_per_pupil,
    x_first_language_not_english,
    violent_crime,
    total_sat,
    x_graduated,
    x_attending_college
  )) %>% drop_na()

indep_vars.sat <- data_hs.lm_training %>% dplyr::select(-c(x_graduated, x_attending_college))
lm.sat <- lm(total_sat ~ ., data = indep_vars.sat)
summary(lm.sat)

indep_vars.grad <- data_hs.lm_training %>% dplyr::select(-c(total_sat, x_attending_college))
lm.grad <- lm(x_graduated ~ ., data = indep_vars.grad)
summary(lm.grad)

indep_vars.coll <- data_hs.lm_training %>% dplyr::select(-c(x_graduated, total_sat))
lm.coll <- lm(x_attending_college ~ ., data = indep_vars.coll)
summary(lm.coll)
```


**Nueral Net**
```{r}

```

